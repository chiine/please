<!-- 아이템 상세 페이지 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
            calculateTotalPrice();
            $("#count").change( function(){
                calculateTotalPrice();
            });
        });

        <!-- 상품 결제 금액 -->
        function calculateTotalPrice(){
            var count = $("#count").val();
            var price = $("#price").val();
            var totalPrice = price*count;
            $("#totalPrice").html(totalPrice + '원');
        }

        <!-- 상품 주문하기 -->
        function order(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/order";
            var paramData = {
                itemId : $("#itemId").val(),
                count : $("#count").val()
            };

            var param = JSON.stringify(paramData);

            $.ajax({
                url      : url,
                type     : "POST",
                contentType : "application/json",
                data     : param,
                beforeSend : function(xhr){
                    /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                    xhr.setRequestHeader(header, token);
                },
                dataType : "json",
                cache   : false,
                success  : function(result, status){
                    alert("주문이 완료 되었습니다.");
                    location.href='/post';
                },
                error : function(jqXHR, status, error){

                    if(jqXHR.status == '401'){
                        alert('로그인 후 이용해주세요');
                        location.href='/members/login';
                    } else{
                        alert(jqXHR.responseText);
                    }

                }
            });
        }
        <!-- 상품 장바구니 담기 -->
        function addCart(){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/cart";
            var paramData = {
                itemId : $("#itemId").val(),
                count : $("#count").val()
            };

            var param = JSON.stringify(paramData);

            $.ajax({
                url      : url,
                type     : "POST",
                contentType : "application/json",
                data     : param,
                beforeSend : function(xhr){
                    /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                    xhr.setRequestHeader(header, token);
                },
                dataType : "json",
                cache   : false,
                success  : function(result, status){
                    alert("상품을 장바구니에 담았습니다.");
                    //location.href='/itemList';
                },
                error : function(jqXHR, status, error){

                    if(jqXHR.status == '401'){
                        alert('로그인 후 이용해주세요');
                        location.href='/members/login';
                    } else{
                        alert(jqXHR.responseText);
                    }

                }
            });
        }
    </script>
</th:block>

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
    <style>
        .mgb-15{margin-bottom:15px;}
        .mgt-30{margin-top:30px;}
        .mgt-50{margin-top:50px;}
        .repImgDiv{margin-right:15px;height: auto;width:50%;}
        .repImg{width:100%;height:300px;}
        .wd50{height:auto;width:50%;}
        .text-right {text-align : right;}

        .badge {border-radius : 3px;font-weight : 500;font-size :16px;cursor:default;}
        .btn-lg {display : inline-block;margin: 10px 5px 20px 5px;border-radius : 0px;min-width : 100px;}
        .btn-cart {background-color : #f9f9f9;border : 0.5px solid black;color : black;}
        .btn-order {background-color : #333;color : #f9f9f9;}
        .my-4 {background-color : #ccc;}
        .tp {display : flex;justify-content: space-between;margin-top : 40px;}
        #totalPrice {margin: 0;}
    </style>
</th:block>

<div layout:fragment="content">
	<div id="inwrap02">
		<div class="p_title"><img src="/img/pet_icon13.png">스토어</div>
	    <input type="hidden" id="itemId" th:value="${item.id}">	
	    <div class="item_infobox">
	        <div class="item_info_img">
	            <img th:src="${item.itemImgDtoList[0].imgUrl}" th:alt="${item.itemNm}">
	        </div>
	        <div class="item_info_text">
	            <span th:if="${item.itemSellStatus == T(com.busanit.petgathering.constant.ItemSellStatus).SELL}"
	                  class="badge badge-primary mgb-15">
	                판매중
	            </span>
	            <span th:unless="${item.itemSellStatus == T(com.busanit.petgathering.constant.ItemSellStatus).SELL}"
	                  class="badge btn-danger mgb-15">
	                품절
	            </span>
	            <div class="h2" th:text="${item.itemNm}"></div>
	            <p>본 상품은 유통기한 책임제 상품이며, 댕댕챱챱에서 100% 정품임을 보증합니다.<br>안심하시고 급여하세요!</p>
	            <div class="h4" style="margin-top :30px;">
	                <input type="hidden" th:value="${item.price}" id="price" name="price">
	                <span class="h4_title">판매가격</span>
	                <span th:text="${item.price}" style="text-decoration: line-through;"></span>원<br>
	            </div>
	            <div class="h4" style="margin-top : 15px;">
	                <input type="hidden" th:value="${item.price}" id="price" name="price">
	                <span class="h4_title">할인가격</span>
	                <span th:text="${item.price}"></span>원
	            </div>
	            
	            <div class="item_count" style="margin-top : 15px;">
	                <span class="h4_title">수량</span>
	                <input type="number" name="count" id="count" value="1" min="1">
	            </div>
	            
	            <div class="h4" style="margin-top :30px;">
	                <span class="h4_title" style="color:#222;font-weight:bold;">총 가격</span>
	                <span name="totalPrice" id="totalPrice" style="color:tomato;font-size:24px;font-weight:bold;"></span>
	            </div>
	
	            <hr class="my-4" style="margin: 30px 0 20px !important;">
	
	            <div th:if="${item.itemSellStatus == T(com.busanit.petgathering.constant.ItemSellStatus).SELL}">
	                <button type="button" class="Btn Btn05 btn_cart btn_left" onclick="addCart()">
						<i class="fas fa-cart-plus" aria-hidden="true"></i> 장바구니 담기
	                </button>
	                <button type="button" class="Btn Btn05 btn_order" onclick="order()">
						<i class="fas fa-credit-card" aria-hidden="true"></i> 주문하기
					</button>
	            </div>
	            <div th:unless="${item.itemSellStatus == T(com.busanit.petgathering.constant.ItemSellStatus).SELL}">
	                <button type="button" class="Btn Btn05 btn_soldout">품절</button>
	            </div>
	        </div>
	    </div>
	    
	    <div class="item_tbox">
            <p class="item_text_title"><img src="/img/pet_icon06.png"> 상품 상세 설명</p>
            <pre class="item_text_lead" th:text="${item.itemDetail}"></pre>
		    <div class="item_tbox_img" th:each="itemImg : ${item.itemImgDtoList}">
		        <img th:if="${not #strings.isEmpty(itemImg.imgUrl)}" th:src="${itemImg.imgUrl}">
		    </div>
	    </div>       
								
		<div class="Btn_box02">
			<div class="Btn Btn02 Btn_L btn_left"><a href="/store">목록보기</a></div>
		</div>
	
	    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </div>
</div>

</html>